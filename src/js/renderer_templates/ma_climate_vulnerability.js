(() => {
  let layers = {}

  RendererTemplates.ma_climate_vulnerability_layers = () => {
    return layers;
  };

  RendererTemplates.ma_climate_vulnerability = (layer_id, opts) => {
    source: "NESCAUM",
    layers[opts.display_name] = layer_id;

    var renderer = RendererTemplates.wms(layer_id, _.merge({
      parameters: {
        opacity: 70,
        town: false,
        wms_layer: opts.wms_layer,
      },

      clone_layer_name: function(active_layer) {
        return active_layer.name + " Layer:" + active_layer.parameters.town;
      },
      url: CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms"),
      wms_opts:(active_layer) => {
        //var cql_filter=escape("cql_filter=town='Falmouth' AND climate_effect='exposure'");
        var town = active_layer.parameters.town;
        return  {
          layers: opts.wms_layer,
          cql_filter: "town='" + town + "'",
          format: "image/png",
          opacity: 0,
          zIndex: -1,
          transparent: true,
        };
      },
      get_feature_info_url: function (active_layer) {
        var town = active_layer.parameters.town;

        return CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms") +
              "?SERVICE=WMS&VERSION=1.1.1&"+
              "REQUEST=GetFeatureInfo&LAYERS=" + opts.wms_layer + "&"+
              "QUERY_LAYERS=" + opts.wms_layer + "&"+
              "CQL_FILTER=town='" + town + "'&"+
              "PROPERTYNAME=county,town,climate_effect,category,label,stats&"+
              "STYLES=&"+
              "BBOX=<%= bbox %>&"+
              "FEATURE_COUNT=5&"+
              "HEIGHT=<%= height %>&"+
              "WIDTH=<%= width %>&"+
              "FORMAT=text%2Fhtml&"+
              "INFO_FORMAT=application%2Fjson&"+
              "SRS=EPSG%3A4326&"+
              "X=<%= x %>&Y=<%= y %>";
      },
      legend_template: `
          <div class='detail-block show-confidence'>
            <label> Legend: </label>
              <img src='http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms?request=GetLegendGraphic&LAYER={{parameters.wms_layer}}&format=image/png'/>
          </div>
      `,
      got_feature_info_response: function (active_layer, data) {
        return new Promise( (win, lose) => {
          let county = CLIMATE_VULNERABILITY_TOWN_TO_COUNTY[active_layer.parameters.town];
          if (county && opts.gfi_fields && opts.gfi_fields.length > 0) {
            let url = CDN("http://repository.nescaum-ccsc-dataservices.com/climate-data/details")
            let args = {"variables": opts.gfi_fields.join(','),
                        "states": "ma",
                        "years": "2090",
                        "counties": county};
            $.getJSON(url, args, (resp) => {
              // Group by variable, then each season, then the values.
              let processed = {};
              resp.forEach((v) => {
                _.set(processed, [v.year, v.variable, v.season], v.data);
              });
              win({'keypath': 'ma_climate_vulnerability_response', 'value': processed});
            });
          }
        });
      },
    }, opts));
  }
})();
