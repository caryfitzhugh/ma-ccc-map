(() => {
  let _name2layer = {
    "Stormwater Flooding": "flood",
    "Sea Level Rise": 'slr',
    "Extreme Heat": "extreme_heat",
    "Drought": "drought"
  };
  let info_data_fields = {
    "Stormwater Flooding": ["precip", "precipgt1", "precipgt2"],
    "Sea Level Rise": [],
    "Extreme Heat": ['avgtemp', 'tempgt_90', 'tempgt_95', 'cooldegdays']
  };

  RendererTemplates.wms("climate_vulnerability", {
    parameters: {
      opacity: 100,
      town: false,
      layer: false,
      name2layer: _name2layer,
    },
    clone_layer_name: function(active_layer) {
      return active_layer.name + " Layer:" + active_layer.parameters.town + "; " + active_layer.parameters.layer;
    },
    url: CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms"),

    wms_opts:(active_layer) => {
      //var cql_filter=escape("cql_filter=town='Falmouth' AND climate_effect='exposure'");
      var town = active_layer.parameters.town;
      var layer = _name2layer[active_layer.parameters.layer];
      return  {
        layers: 'ma:vulnerability_' + layer,
        cql_filter: "town='" + town + "'",
        format: "image/png",
        opacity: 0,
        zIndex: -1,
        transparent: true,
      };
    },
    get_feature_info_url: function (active_layer) {
      var town = active_layer.parameters.town;
      var layer = _name2layer[active_layer.parameters.layer];

      return CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms") +
            "?SERVICE=WMS&VERSION=1.1.1&"+
            "REQUEST=GetFeatureInfo&LAYERS=ma:vulnerability_" + layer + "&"+
            "QUERY_LAYERS=ma:vulnerability_" + layer + "&"+
            "CQL_FILTER=town='" + town + "'&"+
            "PROPERTYNAME=town,climate_effect,category,label,stats&"+
            "STYLES=&"+
            "BBOX=<%= bbox %>&"+
            "FEATURE_COUNT=5&"+
            "HEIGHT=<%= height %>&"+
            "WIDTH=<%= width %>&"+
            "FORMAT=text%2Fhtml&"+
            "INFO_FORMAT=application%2Fjson&"+
            "SRS=EPSG%3A4326&"+
            "X=<%= x %>&Y=<%= y %>";
    },
    got_feature_info_response: function (active_layer, data) {
      return new Promise( (win, lose) => {
        if (data.features[0]) {
          let url = CDN("http://repository.nescaum-ccsc-dataservices.com/climate-data/details")

          $.getJSON(url, {"variables": info_data_fields[active_layer.parameters.layer].join(",") ,
                          "states": "ma",
                          "counties": data.features[0].properties.county}, (resp) => {
            win({'keypath': 'climate_response', 'value': resp});
          });
        }
      });

      // COUNTY from the get Info Modal response
      //
      // Maybe "if rendererer.got_feature_info_url_response" -- active_layer and then the response object.
      // How would that get pushed? Not sure... extras... view set.. ? dunno yet.
    },
    legend_template: `
        <div class='detail-block show-confidence'>
          <label> Legend: </label>
            <img src='http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms?request=GetLegendGraphic&LAYER=ma:vulnerability_{{parameters.name2layer[parameters.layer]}}&format=image/png'/>
        </div>
    `,
    info_template: `


        {{#if (json.features)}}
            <div class='col-xs-2'>
              <label> {{name}} </label>
            </div>
            <div class='col-xs-10'><table class='table'>
                  <thead>
                    <tr>
                      <th> Climate Effect </th>
                      <th> Category </th>
                      <th> Dataset </th>
                      <th> Town Stats </th>
                    </tr>
                  </thead>
                  <tbody>
                      {{#json.features}}
                        <tr>
                          <td>{{properties.climate_effect}}</td>
                          <td>{{properties.category}}</td>
                          <td>{{properties.label}}</td>
                          <td>{{properties.stats}}</td>
                        </tr>
                      {{/json.features}}
                    </tbody>
                </table>
                {{#if (climate_response)}}
                  <table class='table'>
                    <thead>
                      <tr>
                        <th> </th>
                        <th> Season</th>
                        <th> Baseline </th>
                        <th> 2030s </th>
                        <th> 2050s </th>
                        <th> 2070s </th>
                        <th> 2090s </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td rowspan='2'> Average Temperature </td>
                        <td> Spring</td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                      </tr>
                      <tr class='active-year'>
                        <td class='active-season'> Summer</td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                        <td> 99.3 </td>
                      </tr>
                    </tbody>
                  </table>
                {{/if (climate_response)}}
            </div>
        {{/if json.features }}
    `
  });
})();
