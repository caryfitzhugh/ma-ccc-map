(() => {
  let _name2layer = {
    "Stormwater Flooding": "flood",
    "Sea Level Rise": 'slr',
    "Extreme Heat": "extreme_heat"
  };
  RendererTemplates.wms("climate_vulnerability", {
    parameters: {
      opacity: 100,
      town: false,
      layer: false,
      name2layer: _name2layer,
    },
    clone_layer_name: function(active_layer) {
      return active_layer.name + " Layer:" + active_layer.parameters.town + "; " + active_layer.parameters.layer;
    },
    url: CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms"),
    wms_opts:(active_layer) => {
      //var cql_filter=escape("cql_filter=town='Falmouth' AND climate_effect='exposure'");
      var town = active_layer.parameters.town;
      var layer = _name2layer[active_layer.parameters.layer];
      return  {
        layers: 'ma:vulnerability_' + layer,
        cql_filter: "town='" + town + "'",
        format: "image/png",
        opacity: 0,
        zIndex: -1,
        transparent: true,
      };
    },
    get_feature_info_url: function (active_layer) {
      var town = active_layer.parameters.town;
      var layer = _name2layer[active_layer.parameters.layer];

      return CDN("http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms") +
            "?SERVICE=WMS&VERSION=1.1.1&"+
            "REQUEST=GetFeatureInfo&LAYERS=ma:vulnerability_" + layer + "&"+
            "QUERY_LAYERS=ma:vulnerability_" + layer + "&"+
            "CQL_FILTER=town='" + town + "'&"+
            "PROPERTYNAME=county,town,climate_effect,category,label,stats&"+
            "STYLES=&"+
            "BBOX=<%= bbox %>&"+
            "FEATURE_COUNT=5&"+
            "HEIGHT=<%= height %>&"+
            "WIDTH=<%= width %>&"+
            "FORMAT=text%2Fhtml&"+
            "INFO_FORMAT=application%2Fjson&"+
            "SRS=EPSG%3A4326&"+
            "X=<%= x %>&Y=<%= y %>";
    },
    legend_template: `
        <div class='detail-block show-confidence'>
          <label> Legend: </label>
            <img src='http://geoserver.nescaum-ccsc-dataservices.com/geoserver/ma/wms?request=GetLegendGraphic&LAYER=ma:vulnerability_{{parameters.name2layer[parameters.layer]}}&format=image/png'/>
        </div>
    `,
    info_template: `
        {{#if (json.features)}}
            <div class='col-xs-2'>
              <label> {{name}} </label>
            </div>
            <div class='col-xs-10'><table class='table'>
                  <thead>
                    <tr>
                      <th> Climate Effect </th>
                      <th> Category </th>
                      <th> Dataset </th>
                      <th> Town Stats </th>
                    </tr>
                  </thead>
                  <tbody>
                      {{#json.features}}
                        <tr>
                          <td>{{properties.climate_effect}}</td>
                          <td>{{properties.category}}</td>
                          <td>{{properties.label}}</td>
                          <td>{{properties.stats}}</td>
                        </tr>
                      {{ else }}
                        Unknown / No Response
                      {{/json.features}}
                    </tbody>
                </table>
            </div>
        {{/if json.features }}
    `
  });
})();
